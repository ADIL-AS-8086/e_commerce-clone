<%- include('../partials/usernav')%>




    <form action="" id="checkout-form">
        <section class="bg-white py-5">


            <div class="container">
                <h4 class="card-title mb-4">Checkout
                    <i class="fa-regular fa-money-bill-1  text-dark ms-2 fs-4" style="color: #000000;"></i>
                </h4>
                <div class="row">

                    <div class="col-xl-8 col-lg-8">
                        <!-- Checkout -->
                        <div class="card shadow-0 border">
                            <div class="p-4">
                                <h5 class="card-title mb-3">Select Address</h5>

                                <div class="row mb-3">
                                    <% UserData.address.forEach((address, index)=> { %>
                                        <div class="col-lg-4 mb-3">
                                            <!-- Address radio -->
                                            <div class="form-check h-100 border rounded-3">
                                                <div class="p-3">
                                                    <input required class="form-check-input" type="radio" name="address"
                                                        id="flexRadioDefault<%= index %>" value="<%= address._id %>" />
                                                    <label class="form-check-label" for="flexRadioDefault<%= index %>">
                                                        Address No: <strong>
                                                            <%= index + 1 %>
                                                        </strong><br /><br>

                                                        <small class="text-muted" style="font-weight: bold;">
                                                            <span style="font-weight: bolder; color: black;"> Name:
                                                            </span>
                                                            <%= address.name %>
                                                        </small><br>
                                                        <small class="text-muted" style="font-weight: bold;">
                                                            <span style="font-weight: bolder; color: black;"> City:
                                                            </span>
                                                            <%= address.city %>
                                                        </small><br>
                                                        <small class="text-muted" style="font-weight: bold;">
                                                            <span style="font-weight: bolder; color: black;"> Address:
                                                            </span>
                                                            <%= address.address %>
                                                                <%=address.pincode%>
                                                        </small><br>
                                                        <small class="text-muted" style="font-weight: bold;">
                                                            <span style="font-weight: bolder; color: black;"> state:
                                                            </span> : <%= address.state%>
                                                        </small><br>
                                                        <small class="text-muted" style="font-weight: bold; ">
                                                            <span style="font-weight: bolder; color: black;"> Phone:
                                                            </span>
                                                            <%= address.mobile %>
                                                        </small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <% }); %>

                                </div>
                                <hr>
                                <h5 class="card-title mb-3">Choose PaymentMethod</h5>
                                <div class="row mb-3">


                                    <div class="col-lg-4 mb-3">
                                        <div class="form-check h-100 border rounded-3">
                                            <div class="p-3">
                                                <input required class="form-check-input" type="radio" name="payment"
                                                    id="flexRadioDefault3" value=COD />

                                                <label class="form-check-label" for="flexRadioDefault3">
                                                    <strong>
                                                        COD
                                                    </strong> <br />
                                                    <small class="text-muted">Payment: Cash on delivery
                                                    </small><br>
                                                    <small class="text-muted">Type: Hand to hand</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="form-check h-100 border rounded-3">
                                            <div class="p-3">
                                                <input required class="form-check-input" type="radio" name="payment"
                                                    id="flexRadioDefault3" value=online />

                                                <label class="form-check-label" for="flexRadioDefault3">
                                                    <strong>
                                                        ONLINE PAYMENT
                                                    </strong> <br />
                                                    <small class="text-muted">Payment: ONLINE
                                                    </small><br>
                                                    <small class="text-muted">Type: online transaction</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="form-check h-100 border rounded-3">
                                            <div class="p-3">
                                                <% if(userCart.TotalAmount< UserData.wallet){%>
                                                    <input required class="form-check-input" type="radio" name="payment"
                                                        id="flexRadioDefault3" value="wallet" />
                                                    <label class="form-check-label" for="flexRadioDefault3">
                                                        <strong>Wallet Payment</strong> <br />
                                                        <small class="text-muted">Payment: ONLINE</small><br>
                                                        <small class="text"
                                                            style="font-weight: bold; font-size: 15px; color: rgb(60, 255, 0);">
                                                            BALANCE: ₹<span id="walletBalance">
                                                                <%= UserData.wallet %>
                                                            </span>
                                                        </small>
                                                    </label>
                                                    <%}else{%>
                                                        <input required class="form-check-input" type="radio"
                                                            name="payment" id="flexRadioDefault3" value="wallet"
                                                            disabled />
                                                        <label class="form-check-label" for="flexRadioDefault3">
                                                            <strong>Wallet Payment</strong> <br />
                                                            <small class="text-muted">Payment: ONLINE</small><br>
                                                            <small class="text"
                                                                style="font-weight: bold; font-size: 15px; color: rgb(60, 255, 0);">
                                                                BALANCE: ₹<span id="walletBalance">
                                                                    <%= UserData.wallet %>
                                                                </span>
                                                            </small>
                                                        </label>
                                                        <%}%>
                                            </div>
                                        </div>
                                    </div>



                                </div>
                                <hr>
                                <h5 class="card-title mb-3">Choose Shipping Type</h5>
                                <div class="row mb-3">

                                    <div class="col-lg-4 mb-3">
                                        <div class="form-check h-100 border rounded-3">
                                            <div class="p-3">
                                                <input class="form-check-input" type="radio" name="shipping" required
                                                    id="flexRadioDefault3" value="  Specmen" />
                                                <label class="form-check-label" for="flexRadioDefault3">
                                                    <strong>
                                                        SPECMEN
                                                    </strong><br />
                                                    <small class="text-muted">Partner: Specmen
                                                    </small><br>
                                                    <small class="text-muted">Type: Standerd
                                                    </small><br>
                                                    <small class="text-muted">Shipping Charge: Free
                                                    </small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>



                                </div>
                                <div class="float-end">
                                    <a href="/user/user-cart">
                                        <p class="btn btn-light border" style="margin-top: 15px;">Cancel </p>
                                    </a>
                                    <button class="btn btn-success shadow-0 border" type="submit">Place Order</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div
                        class="col-xl-4 col-lg-4 d-flex justify-content-center justify-content-lg-end border card shadow-0 mb-5">
                        <div class="container py-5">
                            <div class="row ">
                                <div class="card mb-3 border shadow-0">
                                    <div class="card-body">
                                        <form>
                                            <div class="form-group">
                                                <label class="form-label">Have coupon?</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control border" id="couponCode"
                                                        placeholder="Coupon Code" aria-label="Coupon Code"
                                                        aria-describedby="applyCouponBtn" />
                                                    <button class="btn btn-light border shadow-0" type="button"
                                                        id="applyCouponBtn">
                                                        Apply
                                                    </button>

                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <h5 class="mb-5 ms-lg-4 mt-4 mt-lg-0 text-decoration-underline">Checkout Overview
                                </h5>

                                <div class="ms-lg-4 mt-4 mt-lg-0 " style="max-width: 320px;">
                                    <h6 class="mb-5">Summary</h6>
                                    <div class="d-flex justify-content-between">
                                        <p class="mb-2" style="font-weight: bold;">Total price:</p>
                                        <p class="mb-2" style="font-weight: bold;">₹<span id="summary">
                                                <%=userCart.TotalAmount%>
                                            </span>.00</p>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <p class="mb-2">Discount:</p>
                                        <p class="mb-2 text-danger" id="couponInfo"></p>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <p class="mb-2">Shipping cost:</p>
                                        <p class="mb-2"><span id="shippingCost"></span>000</p>
                                    </div>

                                    <hr />

                                    <div class="d-flex justify-content-between">
                                        <p class="mb-2" style="font-weight: bold;">Overall price: <%=
                                                userCart.TotalAmount %>
                                        </p>
                                        <p class="mb-2 fw-bold"><span id="totalPrice"></span></p>
                                    </div>
                                    <hr />

                                    <h6 class="text-dark my-4">Items in cart</h6>

                                    <input type="text" name="productList" hidden required value="<%=UserData._id%>">
                                    <% userCart.cartItems.forEach((cartItem, index)=> { %>
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="me-3 position-relative">
                                                <span
                                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill badge-secondary bg-danger">
                                                    <%=cartItem.quantity %>
                                                </span>
                                                <a href="/user/user-cart">
                                                    <img src="/productimages/<%= cartItem.products.images[0].filename %>"
                                                        style="height: 96px; width: 96px;"
                                                        class="img-sm rounded border" />
                                                </a>
                                            </div>
                                            <div class="">
                                                <a href="/user/user-cart"
                                                    class="text-dark text-decoration-none fw-bold">
                                                    <%= cartItem.products.name %>
                                                </a>
                                                <div class="price text-muted">
                                                    Total: ₹ <%= cartItem.totalPrice%>
                                                </div>
                                            </div>
                                        </div>
                                        <% }); %>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </form>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        window.onload = function () {
            document.getElementById('applyCouponBtn').addEventListener('click', function () {
                const couponCode = document.getElementById('couponCode').value;
                const total = parseFloat(document.getElementById('summary').innerText.replace('₹', ''));
                $.ajax({
                    url: '/user/apply-coupon',
                    method: 'POST',
                    data: {
                        couponCode: couponCode,
                        total: total
                    },
                    success: function (response) {
                        if (response.success) {
                            const couponInfoElement = document.getElementById('couponInfo');
                            const totalPriceElement = document.getElementById('totalPrice');

                            if (response.discount) {
                                couponInfoElement.innerHTML = `Coupon: -₹${response.discount}`;
                                totalPriceElement.innerText = `₹${response.grandTotal}`;
                            } else {
                                couponInfoElement.innerHTML = `<b>No Coupon</b>`;
                                totalPriceElement.innerText = `₹${response.grandTotal}`;
                            }
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (error) {
                        alert(response.error);
                        console.error('Error applying coupon:', error);
                    }
                });
            });

            $("#checkout-form").submit((e) => {
                e.preventDefault();
                const selectedAddress = $("input[name='address']:checked").val();
                if (!selectedAddress) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Please add an address before confirming the order.",
                    });
                    return;
                }


                $.ajax({
                    url: '/user/placeOrder',
                    method: 'post',
                    data: $('#checkout-form').serialize(),
                    success: (response) => {
                        if (response.codSuccess) {
                            window.location = '/user/ordersuccess';
                        } else if (response.online) {
                            Swal.fire({
                                title: 'Pay with Online',
                                text: 'Proceeding with online payment...',
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes, proceed!',
                                cancelButtonText: 'Cancel'
                            })
                            handlePayNowClick(response,);
                        } else if (response.wallet) {

                            if (response.walletSuccess) {
                                window.location = '/user/ordersuccess';
                            } else {
                                alert('Wallet payment failed. Please try again.');
                                $('#checkout-form button[type="submit"]').prop('disabled', true);
                            }
                        } else {
                            alert(response.error);
                            if (confirm) {
                                window.location = '/user/user-cart';
                            }
                        }
                    }
                });
            });


            function handlePayNowClick(order,) {
                console.log(order.createdOrder, "@@@@@@@@");
                var options = {
                    "key": "rzp_test_evMKTjM3ykRhMJ",
                    "amount": order.createdOrder.amount,
                    "currency": "INR",
                    "name": "SPEC MEN",
                    "description": "Test Transaction",
                    "image": "",
                    "order_id": order.createdOrder.id,
                    "handler": function (response) {
                        Swal.fire({
                            title: 'Payment Successful',
                            text: 'Your payment was successful!',
                            icon: 'success',
                            showCancelButton: false,
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        })
                        verifyPayment(response, order);
                    },
                    "prefill": {
                        "user": '<%= UserData._id %>',
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    },
                    "theme": {
                        "color": "#000000"
                    }
                };

                var rzp1 = new Razorpay(options);

                rzp1.on('payment.failed', function (response) {
                    console.error('Payment failed:', response.error.code, response.error.description);
                });

                rzp1.open();
                console.log("Razorpay opened");





            }


            function verifyPayment(payment, order) {
                $.ajax({
                    url: '/user/verify-payment',
                    data: {
                        payment,
                        order
                    },
                    method: 'post',
                    success: (response) => {
                        if (response.success) {
                            location.href = '/user/ordersuccess';
                        } else {
                            location.href = '/';
                        }
                    }
                });
            }
        };

    </script>



    <%- include('../partials/userlogfoter')%>